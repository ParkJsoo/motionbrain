# Phase 1-5: TB6612FNG 연동 단계별 가이드

## 현재 상태 요약

### 완료된 작업

- ✅ **Phase 1-1 ~ 1-4**: 프로젝트 구조, 상태 머신, 안전 규칙, 시리얼 명령
- ✅ **Phase 1.5**: Wi-Fi AP, 웹 UI, 모바일 입력
- ✅ **Phase 1-5 Step 1-1**: 드라이버 전원 연결 및 측정
  - 3개 TB6612FNG 드라이버 연결 완료
  - VCC: 4.75V (정상)
  - VM: 4.75V (정상)
  - GND: 0.15Ω (정상)

### 코드 구현 상태

- ✅ `MotorControl` 클래스 구현 완료
- ✅ 핀 맵 정의 완료
- ✅ PWM 채널 설정 완료
- ✅ 안전 규칙 통합 완료
- ✅ 점진적 속도 변경 (Ramp) 구현 완료

---

## 핀 맵 설계 및 검증

### ESP32 → TB6612FNG 핀 연결

#### TB6612FNG #1 (M1: 그리퍼, M2: 손목)

| TB6612FNG 핀 | ESP32 GPIO | 기능      | 비고         |
| ------------ | ---------- | --------- | ------------ |
| AIN1         | GPIO 16    | M1 방향 1 | OUTPUT       |
| AIN2         | GPIO 17    | M1 방향 2 | OUTPUT       |
| PWMA         | GPIO 18    | M1 PWM    | PWM (채널 0) |
| BIN1         | GPIO 19    | M2 방향 1 | OUTPUT       |
| BIN2         | GPIO 21    | M2 방향 2 | OUTPUT       |
| PWMB         | GPIO 22    | M2 PWM    | PWM (채널 1) |

#### TB6612FNG #2 (M3: 팔꿈치, M4: 어깨)

| TB6612FNG 핀 | ESP32 GPIO | 기능      | 비고         |
| ------------ | ---------- | --------- | ------------ |
| AIN1         | GPIO 23    | M3 방향 1 | OUTPUT       |
| AIN2         | GPIO 25    | M3 방향 2 | OUTPUT       |
| PWMA         | GPIO 26    | M3 PWM    | PWM (채널 2) |
| BIN1         | GPIO 27    | M4 방향 1 | OUTPUT       |
| BIN2         | GPIO 32    | M4 방향 2 | OUTPUT       |
| PWMB         | GPIO 33    | M4 PWM    | PWM (채널 3) |

#### TB6612FNG #3 (M5: 베이스)

| TB6612FNG 핀 | ESP32 GPIO | 기능      | 비고                  |
| ------------ | ---------- | --------- | --------------------- |
| AIN1         | GPIO 12    | M5 방향 1 | OUTPUT (부팅 시 주의) |
| AIN2         | GPIO 13    | M5 방향 2 | OUTPUT                |
| PWMA         | GPIO 14    | M5 PWM    | PWM (채널 4)          |
| BIN1         | GPIO 0     | 미사용    | **사용 금지** (부팅 모드 핀) |
| BIN2         | GPIO 35    | 미사용    | INPUT ONLY (사용 불가) |
| PWMB         | -          | 미사용    | -                     |

### 전원 연결

#### 공통 연결

- **ESP32 GND** ↔ **TB6612FNG #1, #2, #3 GND** (공통 GND)
- **ESP32 5V** ↔ **TB6612FNG #1, #2, #3 VCC** (로직 전원)

#### 모터 전원 (Step 1에서는 미연결)

- **외부 전원 공급 장치 +** ↔ **TB6612FNG #1, #2, #3 VM** (모터 전원)
- **외부 전원 공급 장치 -** ↔ **공통 GND**

### 핀 맵 검증 결과

#### ✅ 정상 핀

- GPIO 16, 17, 18, 19, 21, 22, 23, 25, 26, 27, 32, 33: 모두 정상 사용 가능
- GPIO 13, 14: 정상 사용 가능

#### ⚠️ 주의 필요 핀

- **GPIO 12**: 부팅 시 플래시 전압에 민감 (현재 사용 중, 문제 없으면 계속 사용)

#### ❌ 사용 금지 핀

- **GPIO 0**: 부팅 모드 핀 (현재 코드에서 BIN2_3에 할당되어 있으나 실제 사용 안 함)
- **GPIO 35**: INPUT ONLY 핀 (현재 코드에서 PWMB_3에 할당되어 있으나 실제 사용 안 함)

**결론**: 현재 핀 맵은 안전하며, 실제 사용하는 핀들은 모두 정상입니다.

---

## Phase 1-5 세부 단계

### Step 1: 드라이버 전원 연결 및 검증 (진행 중)

#### Step 1-1: 전원 연결 및 측정 ✅ 완료

- [x] ESP32 5V → TB6612FNG #1, #2, #3 VCC 연결
- [x] ESP32 GND → TB6612FNG #1, #2, #3 GND 연결
- [x] VCC 전압 측정: 4.75V (정상)
- [x] VM 전압 측정: 4.75V (정상, Step 1에서는 ESP32 5V 사용)
- [x] GND 저항 측정: 0.15Ω (정상)

#### Step 1-2: 펌웨어 업로드 및 GPIO 핀 검증

**목표**: ESP32가 모든 GPIO 핀을 올바르게 제어하는지 확인

**작업 순서**:

1. **펌웨어 업로드**

   ```bash
   pio run -t upload
   ```

2. **시리얼 모니터 확인**

     - 초기화 로그 확인:
     ```
     === Motor Control Initialization (Phase 1-5: TB6612FNG) ===
     Number of motors: 5
     Number of drivers: 3
     GPIO pins configured
     PWM channels configured (freq: 1000 Hz, resolution: 8-bit)
     [MOTOR] INIT: TB6612FNG initialized - all motors stopped
     Motor control ready (Phase 1-5: Step 1 - Power connection only)
     ```

3. **방향 핀 전압 측정** (모두 LOW 확인)

   - TB6612FNG #1:
     - AIN1 (GPIO 16): **예상값: 0.00V**
     - AIN2 (GPIO 17): **예상값: 0.00V**
     - BIN1 (GPIO 19): **예상값: 0.00V**
     - BIN2 (GPIO 21): **예상값: 0.00V**
   - TB6612FNG #2:
     - AIN1 (GPIO 23): **예상값: 0.00V**
     - AIN2 (GPIO 25): **예상값: 0.00V**
     - BIN1 (GPIO 27): **예상값: 0.00V**
     - BIN2 (GPIO 32): **예상값: 0.00V**
   - TB6612FNG #3:
     - AIN1 (GPIO 12): **예상값: 0.00V**
     - AIN2 (GPIO 13): **예상값: 0.00V**

5. **PWM 핀 전압 측정** (모두 0V 확인)
   - PWMA_1 (GPIO 18): **예상값: 0.00V**
   - PWMB_1 (GPIO 22): **예상값: 0.00V**
   - PWMA_2 (GPIO 26): **예상값: 0.00V**
   - PWMB_2 (GPIO 33): **예상값: 0.00V**
   - PWMA_3 (GPIO 14): **예상값: 0.00V**

6. **PWM 핀 전압 측정 (선택사항, ARMED 상태에서 모터 명령 시)**

   **목적**: PWM 신호가 정상적으로 출력되는지 사전 확인

   **작업 순서**:

   a. **시스템 ARM**
      ```
      arm
      ```
      또는 웹 UI에서 "ARM" 버튼 클릭

   b. **낮은 PWM 값으로 모터 명령** (시리얼 명령)
      ```
      motor forward 1 10
      ```
      - M1을 10% 속도로 정방향 구동 명령
      - **주의**: 모터는 아직 연결하지 않았으므로 실제로는 회전하지 않습니다.

   c. **PWM 핀 전압 측정**

      **측정 방법**:
      - 멀티미터를 **DC 전압 모드**로 설정
      - 빨간색 프로브를 **PWMA_1 (GPIO 18) 핀**에 연결
      - 검은색 프로브를 **GND**에 연결
      - 멀티미터 화면에 표시되는 전압 값을 확인

      **예상값**:
      - **10% PWM**: 약 **0.3V ~ 0.4V** (멀티미터 평균값)
      - **20% PWM**: 약 **0.6V ~ 0.7V**
      - **50% PWM**: 약 **1.6V ~ 1.7V**
      - **100% PWM**: 약 **3.2V ~ 3.3V**

      **이유**: PWM 신호는 빠르게 ON/OFF를 반복하므로, 멀티미터는 이를 평균 전압으로 표시합니다.
      - 10% PWM = 10% 시간 동안 3.3V, 90% 시간 동안 0V → 평균 약 0.33V
      - 실제 측정값은 약간의 오차가 있을 수 있습니다.

   d. **다른 모터들도 테스트** (선택사항)

      ```
      motor forward 2 10
      motor forward 3 10
      motor forward 4 10
      motor forward 5 10
      ```

      각 모터의 PWM 핀 전압을 측정:
      - M2: PWMB_1 (GPIO 22)
      - M3: PWMA_2 (GPIO 26)
      - M4: PWMB_2 (GPIO 33)
      - M5: PWMA_3 (GPIO 14)

   e. **방향 핀 확인** (선택사항)

      - M1 정방향: AIN1 (GPIO 16) = 3.3V, AIN2 (GPIO 17) = 0.00V
      - M1 역방향: AIN1 (GPIO 16) = 0.00V, AIN2 (GPIO 17) = 3.3V

   f. **모든 모터 정지**
      ```
      motor stop all
      ```
      - 모든 PWM 핀: **예상값: 0.00V**
      - 모든 방향 핀: **예상값: 0.00V**

   **완료 기준 (선택사항)**:
   - [ ] ARMED 상태에서 PWM 명령 실행 가능
   - [ ] PWM 핀에서 전압 변화 확인 (멀티미터 평균값)
   - [ ] PWM 값에 비례하여 전압이 증가하는지 확인
   - [ ] STOP 명령으로 모든 핀 0V 복귀

   **주의사항**:
   - 모터는 아직 연결하지 않음
   - PWM 값이 너무 높으면 드라이버 과열 가능 (10% 이하 권장)
   - 멀티미터는 PWM 신호의 평균값을 표시하므로, 실제 PWM 주파수와는 무관하게 평균 전압만 확인 가능

**완료 기준 (필수)**:

- [ ] 시리얼 모니터에서 초기화 로그 정상 출력
- [ ] 모든 방향 핀: 0.00V
- [ ] 모든 PWM 핀: 0.00V (IDLE 상태)
- [ ] 드라이버 과열 없음

**완료 기준 (선택사항 - PWM 핀 전압 측정)**:

- [ ] ARMED 상태에서 PWM 명령 실행 가능
- [ ] PWM 핀에서 전압 변화 확인 (멀티미터 평균값)
- [ ] PWM 값에 비례하여 전압이 증가하는지 확인
- [ ] STOP 명령으로 모든 핀 0V 복귀

**예상 문제 및 해결**:

- **방향 핀이 3.3V**: 코드 확인, GPIO 핀 연결 확인
- **시리얼 로그 없음**: 시리얼 포트 선택, 보드레이트 확인 (115200)

---

### Step 2: PWM 핀 전압 측정 (선택사항, Step 3으로 진행 가능)

**목표**: ARMED 상태에서 모터 명령 시 PWM 핀의 전압 변화를 확인하여 PWM 신호가 정상적으로 출력되는지 검증

**참고**: 이 단계는 선택사항입니다. Step 1-2의 기본 검증이 완료되면 바로 Step 3으로 진행할 수 있습니다. 다만, PWM 신호가 정상적으로 출력되는지 사전에 확인하고 싶다면 이 단계를 수행하세요.

**작업 순서**:

1. **시스템 ARM**

   ```
   arm
   ```

   또는 웹 UI에서 "ARM" 버튼 클릭

2. **시리얼 모니터 확인**

   ```
   [STATE] IDLE -> ARMED
   [COMMAND] arm: System armed
   ```

3. **낮은 PWM 값으로 모터 명령** (시리얼 명령)

   ```
   motor forward 1 10
   ```

   - M1을 10% 속도로 정방향 구동 명령
   - **주의**: 모터는 아직 연결하지 않았으므로 실제로는 회전하지 않습니다.

4. **PWM 핀 전압 측정**

   **측정 방법**:
   - 멀티미터를 **DC 전압 모드**로 설정
   - 빨간색 프로브를 **PWMA_1 (GPIO 18) 핀**에 연결
   - 검은색 프로브를 **GND**에 연결
   - 멀티미터 화면에 표시되는 전압 값을 확인

   **예상값**:
   - **10% PWM**: 약 **0.3V ~ 0.4V** (멀티미터 평균값)
   - **20% PWM**: 약 **0.6V ~ 0.7V**
   - **50% PWM**: 약 **1.6V ~ 1.7V**
   - **100% PWM**: 약 **3.2V ~ 3.3V**

   **이유**: PWM 신호는 빠르게 ON/OFF를 반복하므로, 멀티미터는 이를 평균 전압으로 표시합니다.
   - 10% PWM = 10% 시간 동안 3.3V, 90% 시간 동안 0V → 평균 약 0.33V
   - 실제 측정값은 약간의 오차가 있을 수 있습니다.

5. **다른 모터들도 테스트**

   ```
   motor forward 2 10
   motor forward 3 10
   motor forward 4 10
   motor forward 5 10
   ```

   각 모터의 PWM 핀 전압을 측정:
   - M2: PWMB_1 (GPIO 22)
   - M3: PWMA_2 (GPIO 26)
   - M4: PWMB_2 (GPIO 33)
   - M5: PWMA_3 (GPIO 14)

6. **방향 핀 확인** (선택사항)

   - M1 정방향: AIN1 (GPIO 16) = 3.3V, AIN2 (GPIO 17) = 0.00V
   - M1 역방향: AIN1 (GPIO 16) = 0.00V, AIN2 (GPIO 17) = 3.3V

7. **모든 모터 정지**

   ```
   motor stop all
   ```

   - 모든 PWM 핀: **예상값: 0.00V**
   - 모든 방향 핀: **예상값: 0.00V**

**완료 기준**:

- [ ] ARMED 상태에서 PWM 명령 실행 가능
- [ ] PWM 핀에서 전압 변화 확인 (멀티미터 평균값)
- [ ] PWM 값에 비례하여 전압이 증가하는지 확인
- [ ] STOP 명령으로 모든 핀 0V 복귀

**주의사항**:

- 모터는 아직 연결하지 않음
- PWM 값이 너무 높으면 드라이버 과열 가능 (10% 이하 권장)
- 멀티미터는 PWM 신호의 평균값을 표시하므로, 실제 PWM 주파수와는 무관하게 평균 전압만 확인 가능

---

### Step 3: PWM 신호 출력 테스트

#### Step 3-1: 낮은 PWM 값 테스트 (모터 미연결)

**목표**: PWM 신호가 올바르게 출력되는지 확인 (모터는 아직 연결하지 않음)

**작업 순서**:

1. **시스템 ARM**

   ```
   arm
   ```

2. **낮은 PWM 값으로 테스트** (시리얼 명령)

   ```
   motor forward 1 10
   ```

   - M1을 10% 속도로 정방향 구동

3. **PWM 핀 전압 측정**

   - PWMA_1 (GPIO 18): **예상값: 약 0.3V** (10% = 약 0.1V × 3.3V)
   - 멀티미터로 측정 시 평균 전압으로 표시됨

4. **다른 모터들도 테스트**

   ```
   motor forward 2 10
   motor forward 3 10
   motor forward 4 10
   motor forward 5 10
   ```

5. **방향 핀 확인**

   - M1 정방향: AIN1 = 3.3V, AIN2 = 0.00V
   - M1 역방향: AIN1 = 0.00V, AIN2 = 3.3V

6. **모든 모터 정지**
   ```
   motor stop all
   ```

**완료 기준**:

- [ ] ARMED 상태에서 PWM 명령 실행 가능
- [ ] PWM 핀에서 전압 변화 확인 (멀티미터 평균값)
- [ ] 방향 핀 상태 변경 확인
- [ ] STOP 명령으로 모든 핀 0V 복귀

**주의사항**:

- 모터는 아직 연결하지 않음
- PWM 값이 너무 높으면 드라이버 과열 가능 (10% 이하 권장)

---

### Step 4: 모터 1개 연결 및 낮은 PWM 테스트

#### Step 4-1: 모터 전원 분리 및 M1 모터 연결

**목표**: 모터 1개만 연결하여 안전하게 테스트

**작업 순서**:

1. **외부 전원 공급 장치 준비**

   - 모터 전압에 맞는 전원 (예: 6V, 12V 등)
   - 전류 용량 확인 (모터 정격 전류 × 1.5배 이상)

2. **모터 전원 연결**

   - 외부 전원 + → TB6612FNG #1 VM
   - 외부 전원 - → 공통 GND
   - **주의**: 전원 공급 장치를 켜기 전에 모든 연결 확인

3. **M1 모터 연결** (TB6612FNG #1 모터 A)

   - 모터 + → TB6612FNG #1 A01
   - 모터 - → TB6612FNG #1 A02

4. **전원 공급 장치 전압 확인**

   - VM 핀 전압 측정: 모터 전압과 일치하는지 확인

5. **시스템 ARM 및 낮은 PWM 테스트**

   ```
   arm
   motor forward 1 5
   ```

   - 5% 속도로 시작 (매우 낮은 속도)

6. **모터 동작 확인**

   - 모터가 부드럽게 회전하는지 확인
   - 이상 소음, 과열 없음 확인

7. **역방향 테스트**

   ```
   motor reverse 1 5
   ```

8. **정지 및 DISARM**
   ```
   motor stop 1
   disarm
   ```

**완료 기준**:

- [ ] 모터가 부드럽게 회전
- [ ] 정방향/역방향 모두 정상 동작
- [ ] 드라이버 과열 없음
- [ ] 이상 소음 없음
- [ ] STOP 명령으로 즉시 정지

**안전 주의사항**:

- 처음에는 반드시 5% 이하 속도로 테스트
- 모터가 이상하게 동작하면 즉시 전원 차단
- 드라이버 과열 시 즉시 정지

---

### Step 5: 듀얼 모터 확장 테스트

#### Step 5-1: TB6612FNG #1의 두 모터 동시 테스트

**목표**: 같은 드라이버의 두 모터가 독립적으로 동작하는지 확인

**작업 순서**:

1. **M2 모터 연결** (TB6612FNG #1 모터 B)

   - 모터 + → TB6612FNG #1 B01
   - 모터 - → TB6612FNG #1 B02

2. **M1, M2 독립 제어 테스트**

   ```
   arm
   motor forward 1 10
   motor forward 2 10
   ```

   - 두 모터가 독립적으로 회전하는지 확인

3. **하나만 정지 테스트**

   ```
   motor stop 1
   ```

   - M1만 정지, M2는 계속 회전

4. **역방향 테스트**

   ```
   motor reverse 1 10
   motor reverse 2 10
   ```

5. **모든 모터 정지**
   ```
   motor stop all
   disarm
   ```

**완료 기준**:

- [ ] M1, M2가 독립적으로 제어됨
- [ ] 하나만 정지해도 다른 모터는 계속 동작
- [ ] 두 모터 동시 구동 시 드라이버 과열 없음

---

### Step 6: 모든 모터 연결 및 통합 테스트

#### Step 6-1: 나머지 모터 연결

**작업 순서**:

1. **TB6612FNG #2 연결** (M3, M4)

   - 외부 전원 + → TB6612FNG #2 VM
   - M3 모터 연결 (모터 A)
   - M4 모터 연결 (모터 B)

2. **TB6612FNG #3 연결** (M5)

   - 외부 전원 + → TB6612FNG #3 VM
   - M5 모터 연결 (모터 A)

3. **모든 모터 전원 공급**
   - 모든 VM 핀에 전원 연결 확인
   - 전원 공급 장치 용량 확인 (모든 모터 전류 합계)

#### Step 6-2: 통합 테스트

**작업 순서**:

1. **각 모터 개별 테스트**

   ```
   arm
   motor forward 1 10
   motor stop 1
   motor forward 2 10
   motor stop 2
   # ... M3, M4, M5도 동일하게 테스트
   ```

2. **여러 모터 동시 구동 테스트**

   ```
   motor forward 1 10
   motor forward 2 10
   motor forward 3 10
   ```

3. **웹 UI 테스트**

   - 조이스틱 모드에서 여러 모터 동시 제어
   - 버튼 모드에서 각 모터 개별 제어

4. **안전 기능 테스트**
   - DISARM 시 모든 모터 즉시 정지
   - 타임아웃 시 자동 DISARM 및 정지
   - STOP 버튼으로 긴급 정지

**완료 기준**:

- [ ] 모든 모터 개별 제어 정상
- [ ] 여러 모터 동시 구동 정상
- [ ] 웹 UI에서 모든 모터 제어 가능
- [ ] 안전 기능 모두 정상 동작
- [ ] 드라이버 과열 없음

---

## 체크리스트 요약

### Step 1: 드라이버 전원 연결 및 검증

- [x] 전원 연결 및 측정 완료
- [ ] 펌웨어 업로드
- [ ] 방향 핀 검증 (0V)
- [ ] PWM 핀 검증 (0V)

### Step 2: PWM 핀 전압 측정 (선택사항)

- [ ] ARMED 상태에서 PWM 명령 실행
- [ ] PWM 핀 전압 변화 확인
- [ ] PWM 값에 비례한 전압 증가 확인

### Step 3: PWM 신호 출력 테스트

- [ ] ARMED 상태에서 PWM 명령 실행
- [ ] PWM 핀 전압 변화 확인
- [ ] 방향 핀 상태 변경 확인

### Step 4: 모터 1개 연결 및 테스트

- [ ] 외부 전원 공급 장치 연결
- [ ] M1 모터 연결
- [ ] 낮은 PWM (5%) 테스트
- [ ] 정방향/역방향 테스트

### Step 5: 듀얼 모터 확장 테스트

- [ ] M2 모터 연결
- [ ] M1, M2 독립 제어 테스트
- [ ] 동시 구동 테스트

### Step 6: 모든 모터 연결 및 통합 테스트

- [ ] 나머지 모터 연결 (M3, M4, M5)
- [ ] 모든 모터 개별 테스트
- [ ] 여러 모터 동시 구동 테스트
- [ ] 웹 UI 통합 테스트
- [ ] 안전 기능 테스트

---

## 다음 단계 (Phase 1-5 완료 후)

### Phase 2: 모션 추상화 계층

- 고수준 모션 명령 API 구현
- 모션 명령 큐 시스템
- 중단 및 우선순위 처리

### Phase 3: 입력 · 판단 계층 분리 확장

- 입력 계층과 실행 계층 완전 분리
- 판단 계층에서만 상태 전환

### Phase 4: AI 연계

- 외부 AI 시스템과의 통신 프로토콜
- AI 의도 → ESP32 실행 변환

---

## 안전 주의사항

1. **항상 낮은 속도로 시작**: 처음 테스트 시 5-10% 이하
2. **드라이버 과열 주의**: 터치로 확인, 과열 시 즉시 정지
3. **전원 공급 장치 용량 확인**: 모든 모터 전류 합계 확인
4. **GND 공통 연결 필수**: 모든 GND는 반드시 공통 연결
5. **모터 미연결 시에도 안전**: Step 1-3은 모터 없이도 진행 가능
6. **긴급 정지 준비**: 언제든지 전원 차단 가능하도록 준비

---

**작성일**: 2024
**현재 진행 단계**: Step 1-2 (펌웨어 업로드 및 GPIO 핀 검증)
